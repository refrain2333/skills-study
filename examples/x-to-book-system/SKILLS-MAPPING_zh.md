# 技能映射：X-to-Book 系统

本文档提供了代理上下文工程技能与 X-to-Book 系统 PRD 中的设计决策之间的详细映射。

## 技能：多代理模式

### 应用的概念

| 概念 | 技能参考 | PRD 应用 |
|------|---------|---------|
| 监督者模式 | "监督者模式将中央代理置于控制中，委托给专家并综合结果。" | 协调器代理协调爬虫、分析器、合成器、写手、编辑代理 |
| 上下文隔离 | "子代理主要存在以隔离上下文，而不是将角色拟人化。" | 每个代理在专注于其阶段的清晰上下文中运行 |
| 电话游戏问题 | "LangGraph 基准测试发现监督者架构初期表现差 50%，因为'电话游戏'问题导致监督者不正确地改述子代理响应。" | 阶段输出存储在文件系统中，不通过协调器进行综合 |
| 文件系统协调 | "对于需要共享状态的复杂任务，代理读写持久存储。" | 所有代理间数据流通过文件系统 |
| 监督者瓶颈缓解 | "实现输出架构约束，使工人仅返回精简摘要。" | 协调器接收阶段摘要，永远不接收原始数据 |

### 模式选择理由

技能描述了三种模式：

1. **监督者/协调器**："何时使用：具有明确分解的复杂任务、需要跨域协调的任务。"
2. **点对点/群集**："何时使用：需要灵活探索的任务、严格规划会产生反效果的任务。"
3. **分层**："何时使用：具有明确分层结构的大规模项目。"

**选择**：监督者/协调器

**理由**：书籍生产有明确的顺序阶段（爬虫 → 分析 → 合成 → 写作 → 编辑）。阶段之间的质量门控需要中央协调。人工监督对内容质量很重要。

---

## 技能：上下文基础知识

### 应用的概念

| 概念 | 技能参考 | PRD 应用 |
|------|---------|---------|
| 上下文作为有限资源 | "上下文必须视为有限资源，边际收益递减。" | 每个代理明确的 token 预算（协调器 50k、写手 80k 等） |
| 渐进式信息披露 | "渐进式信息披露通过根据需要加载信息来有效管理上下文。" | 书籍大纲首先加载；章节内容仅在写手处理该章节时加载 |
| 注意力预算 | "模型从训练数据分布中开发注意力模式，其中较短序列占主导。" | 上下文限制保守地设置在模型最大值以下 |
| 工具输出量 | "工具输出构成典型代理轨迹中大部分 token，研究表明观察可达 83.9% 的总上下文使用量。" | 推文数据分别处理，永远不进入主要代理上下文 |

### 上下文预算分配

来自技能："考虑明确的上下文预算进行设计。了解您的模型和任务的有效上下文限制。"

PRD 实现：

```yaml
context_limits:
  orchestrator: 50000   # 仅路由，无原始数据
  scraper: 20000        # 一次一个账户
  analyzer: 80000       # 模式提取
  synthesizer: 100000   # 跨账户合成
  writer: 80000         # 按章节起草
  editor: 60000         # 按章节审查
```

---

## 技能：记忆系统

### 应用的概念

| 概念 | 技能参考 | PRD 应用 |
|------|---------|---------|
| 向量存储限制 | "向量存储丢失关系信息...无法回答'购买产品 Y 的客户还购买了什么产品？'" | 为账户间的关系查询选择知识图谱 |
| 时间有效性 | "时间知识图谱向事实添加有效期。每个事实都有'有效期起始'和可选的'有效期结束'时间戳。" | 所有关系都有时间有效期以追踪立场演变 |
| 实体记忆 | "实体记忆特别追踪关于实体的信息以保持一致性。" | 定义了账户、推文、主题、书籍、章节实体类型 |

### 记忆架构决策

来自技能："根据需求选择记忆架构：简单持久化需求 → 文件系统记忆；语义搜索需求 → 向量 RAG；关系推理需求 → 知识图谱；时间有效性需求 → 时间知识图谱。"

**识别的查询需求**：
- "过去 30 天 @账户对 AI 说了什么？" → 时间 + 实体过滤
- "哪些账户在加密货币上不一致？" → 关系遍历
- "@账户的立场如何演变？" → 时间查询

**选择**：时间知识图谱

---

## 技能：上下文优化

### 应用的概念

| 概念 | 技能参考 | PRD 应用 |
|------|---------|---------|
| 观察掩蔽 | "观察掩蔽用紧凑引用替换冗长的工具输出。" | 原始推文数据存储在文件系统中，不通过上下文传递 |
| 压缩触发器 | "在显著内存积累后、检索返回太多过时结果时触发压缩。" | 70% 上下文使用率触发压缩 |
| KV 缓存优化 | "首先放置稳定元素（系统提示、工具定义），然后是频繁重用的元素，最后是唯一元素。" | 上下文排序：系统提示 → 工具 → 账户配置 → 每日大纲 → 当前任务 |

### 优化策略

来自技能："何时优化：上下文使用率超过 70%、响应质量随对话延伸而降解。"

PRD 实现：
```python
COMPACTION_THRESHOLD = 0.7  # 70% 上下文使用率

if context_utilization > COMPACTION_THRESHOLD:
    phase_outputs = compact_phase_outputs(phase_outputs)
```

来自技能："应用什么：工具输出占主导 → 观察掩蔽"

PRD 实现：所有原始推文数据（可能是 100k+ tokens/天）通过以下方式被掩蔽：
1. 爬虫写入文件系统
2. 分析器从文件系统读取，生成摘要
3. 摘要（不是原始数据）流向后续阶段

---

## 技能：工具设计

### 应用的概念

| 概念 | 技能参考 | PRD 应用 |
|------|---------|---------|
| 整合原则 | "如果人类工程师无法明确说出在给定情况下应该使用哪个工具，代理也不能期望做得更好。" | 3 个合并的工具而不是 15+ 个狭窄的工具 |
| 描述结构 | "有效的工具描述回答四个问题：工具做什么？何时应使用？它接受什么输入？它返回什么？" | 所有工具都有明确的使用触发器和错误恢复 |
| 响应格式选项 | "实现响应格式选项给代理对冗长性的控制。" | 工具支持"简洁"和"详细"格式参数 |
| 错误消息设计 | "错误消息必须可行。它们必须告诉代理出了什么问题以及如何纠正。" | 错误包括恢复指导（RATE_LIMITED 包含 retry_after） |

### 工具整合

来自技能："不是实现 list_users、list_events 和 create_event，实现处理完整工作流的 schedule_event。"

PRD 实现：

**整合前**（我们避免的）：
- `fetch_timeline`
- `fetch_thread`
- `fetch_engagement`
- `search_tweets`
- `store_entity`
- `query_entities`
- `update_validity`
- 等等

**整合后**：
- `x_data_tool` - 所有 X 数据操作
- `memory_tool` - 所有知识图谱操作
- `writing_tool` - 所有内容操作

---

## 技能：评估

### 应用的概念

| 概念 | 技能参考 | PRD 应用 |
|------|---------|---------|
| 多维度评分标准 | "代理质量不是单一维度。它包括事实准确性、完整性、连贯性、工具效率和过程质量。" | 5 个加权维度：源准确性、主题连贯性、完整性、见解质量、可读性 |
| LLM 作为评判者 | "基于 LLM 的评估扩展到大型测试集并提供一致的判断。" | 对连贯性和见解质量的自动化评估 |
| 人工评估 | "人工评估捕捉自动化遗漏的内容。" | 当评分 < 0.7 或源准确性 < 0.8 时触发人工审查 |
| 结果导向的评估 | "解决方案是结果导向的评估，判断代理是否实现了正确的结果同时遵循合理的过程。" | 评估最终书籍质量，而不是中间步骤 |

### 评估评分标准

来自技能："有效的评分标准涵盖关键维度，具有描述性级别。"

PRD 实现：

| 维度 | 权重 | 测量 |
|------|------|------|
| 源准确性 | 30% | 针对原始推文的自动化引用验证 |
| 主题连贯性 | 25% | 对叙述流的 LLM 评判 |
| 完整性 | 20% | 主题覆盖计算 |
| 见解质量 | 15% | 对超越重述的综合的 LLM 评判 |
| 可读性 | 10% | 自动化指标 + LLM 评判 |

---

## 跨技能集成

技能设计为协同工作。此示例演示了集成模式：

| 集成 | 技能组合 | 应用 |
|------|---------|------|
| 代理上下文预算 | multi-agent-patterns + context-fundamentals | 每个代理基于其角色有明确的限制 |
| 文件系统协调 | multi-agent-patterns + context-optimization | 避免上下文传递，启用掩蔽 |
| 记忆感知合成 | memory-systems + context-optimization | 查询相关事实而无需加载完整历史 |
| 质量驱动的路由 | evaluation + multi-agent-patterns | 协调器使用质量评分进行阶段门控 |

这种集成是技能集合的核心价值主张：它们提供补充模式，解决上下文工程的不同方面，同时协同工作。

