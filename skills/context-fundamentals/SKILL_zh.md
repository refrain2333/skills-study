---
name: 上下文基础
description: 理解智能体系统中上下文的组成部分、机制和约束。在设计智能体架构、调试上下文相关故障或优化上下文使用时使用。
---

# 上下文工程基础

上下文是语言模型在推理时可用的完整状态。它包括模型在生成响应时可以关注的所有内容：系统指令、工具定义、检索到的文档、消息历史和工具输出。理解上下文基础是进行有效上下文工程的前提。

## 何时激活

在以下情况下激活本技能：
- 设计新的智能体系统或修改现有架构
- 调试可能与上下文相关的意外智能体行为
- 优化上下文使用以降低令牌成本或提高性能
- 向新团队成员介绍上下文工程概念
- 审查与上下文相关的设计决策

## 核心概念

上下文包含几个不同的组成部分，每个部分都有不同的特征和约束。**注意力机制 (Attention mechanism)** 创造了一个限制有效上下文使用的有限预算。**渐进式披露 (Progressive disclosure)** 通过仅在需要时加载信息来管理这一约束。工程学科的目标是策划实现预期结果的最小、高信号令牌集。

## 详细主题

### 上下文的解剖

**系统提示词 (System Prompts)**
系统提示词确立了智能体的核心身份、约束和行为准则。它们在会话开始时加载一次，通常贯穿整个对话。系统提示词应极其清晰，使用简单、直接的语言，并处于适合智能体的“高度”。

合适的高度平衡了两种失效模式。在一个极端，工程师硬编码复杂的脆性逻辑，造成脆弱性和维护负担。在另一个极端，工程师提供模糊的高层指导，无法为预期输出提供具体信号，或错误地假设了共享上下文。**最佳高度**达到了平衡：既具体到足以有效引导行为，又灵活到足以提供强大的启发式。

使用 XML 标签或 Markdown 标题将提示词组织成不同的章节，以划定背景信息、指令、工具指导和输出描述。随着模型能力的增强，具体格式的重要性会有所降低，但结构清晰度仍然极具价值。

**工具定义 (Tool Definitions)**
工具定义指定了智能体可以采取的操作。每个工具包括名称、描述、参数和返回格式。工具定义在序列化后位于上下文的前部，通常在系统提示词之前或之后。

工具描述集体引导智能体行为。糟糕的描述迫使智能体去猜测；优化的描述包括使用背景、示例和默认值。**整合原则 (Consolidation principle)** 指出：如果人类工程师无法明确说出在特定情况下应使用哪个工具，那么就不能指望智能体做得更好。

**检索到的文档 (Retrieved Documents)**
检索到的文档提供特定领域知识、参考材料或任务相关信息。智能体使用 **检索增强生成 (RAG)** 在运行时将相关文档拉入上下文，而不是预加载所有可能的信息。

**即时 (Just-in-time)** 方法维护轻量级标识符（文件路径、存储的查询、网页链接），并使用这些引用在动态加载数据到上下文中。这模仿了人类的认知：我们通常不背诵整个语料库，而是使用外部组织和索引系统根据需求检索相关信息。

**消息历史 (Message History)**
消息历史包含用户与智能体之间的对话，包括之前的查询、响应和推理。对于运行时间较长的任务，消息历史可能会增长到主导上下文使用的程度。

消息历史充当 **暂存器内存 (scratchpad memory)**，智能体在这里追踪进度、维护任务状态并跨回合保留推理。有效管理消息历史对于完成长跨度任务至关重要。

**工具输出 (Tool Outputs)**
工具输出是智能体操作的结果：文件内容、搜索结果、命令执行输出、API 响应等。工具输出占据了典型智能体轨迹中大部分令牌，研究表明观察结果（工具输出）可达总上下文使用的 83.9%。

工具输出无论是否与当前决策相关都会消耗上下文。这创造了对 **观察掩蔽 (observation masking)**、**压缩 (compaction)** 和 **选择性工具结果保留** 等策略的需求。

### 上下文窗口与注意力机制

**注意力预算约束**
语言模型通过注意力机制处理令牌，该机制在上下文中所有令牌之间建立两两关系。对于 $n$ 个令牌，这创造了必须计算和存储的 $n^2$ 个关系。随着上下文长度的增加，模型捕获这些关系的能力会被拉得很薄。

模型从令牌序列较短的训练数据分布中开发出注意力模式。这意味着模型对长程依赖关系的经验较少，且专门参数也较少。结果就是随着上下文增长而耗尽的“注意力预算”。

**位置编码与上下文扩展**
**位置编码插值 (Position encoding interpolation)** 允许模型通过将长序列适配到最初训练的较小上下文来处理它们。然而，这种适配会引入令牌位置理解的退化。模型在较长上下文中仍保持高度能力，但与在短上下文中的表现相比，信息检索和长程推理的精度有所下降。

**渐进式披露原则**
渐进式披露通过仅在需要时加载信息来高效管理上下文。在启动时，智能体仅加载技能名称和描述——足以知道某项技能何时可能相关。只有当技能针对特定任务被激活时，才会加载全部内容。

这种方法在保持智能体快速运行的同时，让它们能按需访问更多上下文。该原则适用于多个层面：技能选择、文档加载，甚至是工具结果检索。

### 上下文质量与上下文数量

“更大上下文窗口能解决记忆问题”的假设已被经验性地证伪。上下文工程意味着寻找能最大化预期结果概率的最小、高信号令牌集。

几个因素创造了上下文效率的压力：处理成本随上下文长度不成比例地增长（不仅是令牌翻倍成本翻倍，而是时间和计算资源呈指数级增长）；即使窗口在技术上支持更多令牌，模型性能也会在超过一定上下文长度后退化；即使有前缀缓存，长输入仍然昂贵。

指导原则是 **信息量优先于详尽性**。包含对当前决策重要的内容，排除不重要的内容，并设计能按需访问额外信息的系统。

### 上下文作为有限资源

必须将上下文视为具有 **边际收益递减** 的有限资源。就像人类的短时记忆有限一样，语言模型在解析大量上下文时也会消耗注意力预算。

引入的每一个新令牌都会在一定程度上消耗这个预算。这创造了对可用令牌进行精心策划的需求。工程问题是在固有约束下优化效用。

上下文工程是迭代的，每次你决定传递什么给模型时都会发生策划阶段。它不是一次性的提示词编写练习，而是持续进行的上下文管理学科。

## 实践指南

### 基于文件系统的访问

具有文件系统访问权限的智能体可以自然地使用渐进式披露。将参考材料、文档和数据存储在外部。仅在需要时使用标准文件系统操作加载文件。这种模式避免了在上下文中塞满可能无关的信息。

文件系统本身提供了智能体可以导航的结构。文件大小暗示了复杂度；命名约定提示了用途；时间戳充当了相关性的代理。文件引用的元数据提供了一种有效优化行为的机制。

### 混合策略

最有效的智能体采用混合策略。预加载部分上下文以提高速度（如 `CLAUDE.md` 文件或项目规则），但允许自主探索以根据需要获取额外上下文。决策边界取决于任务特征和上下文动态。

对于内容动态性较低的上下文，预加载更多是有意义的。对于快速变化或高度具体的信息，即时加载可以避免上下文过时。

### 上下文预算

设计时要有明确的上下文预算。了解你的模型和任务的有效上下文限制。在开发期间监控上下文使用情况。在适当的阈值处实现压缩触发器。设计系统时假设上下文会退化，而不是希望它不会。

有效的上下文预算不仅需要理解原始令牌计数，还需要理解注意力分布模式。上下文的中间部分获得的注意力比开头和结尾少。将关键信息放在注意力青睐的位置。

## 示例

**示例 1：组织系统提示词**
```markdown
<BACKGROUND_INFORMATION>
你是一名帮助开发团队的 Python 专家。
当前项目：Python 3.9+ 的数据处理管道
</BACKGROUND_INFORMATION>

<INSTRUCTIONS>
- 编写简洁、地道的 Python 代码
- 为函数签名包含类型提示
- 为公共函数添加文档字符串
- 遵循 PEP 8 样式指南
</INSTRUCTIONS>

<TOOL_GUIDANCE>
使用 bash 进行 shell 操作，python 进行代码任务。
文件操作应使用 pathlib 以实现跨平台兼容性。
</TOOL_GUIDANCE>

<OUTPUT_DESCRIPTION>
提供带语法高亮的代码块。
在注释中解释非显而易见的决定。
</OUTPUT_DESCRIPTION>
```

**示例 2：渐进式文档加载**
```markdown
# 而不是一次性加载所有文档：

# 第 1 步：加载摘要
docs/api_summary.md          # 轻量级概览

# 第 2 步：根据需要加载特定章节
docs/api/endpoints.md        # 仅在需要 API 调用时
docs/api/authentication.md   # 仅在需要身份验证上下文时
```

## 指南

1. 将上下文视为边际收益递减的有限资源
2. 将关键信息放在注意力青睐的位置（开头和结尾）
3. 使用渐进式披露延迟加载直到需要
4. 使用清晰的章节边界组织系统提示词
5. 在开发期间监控上下文使用情况
6. 在利用率达到 70-80% 时实现压缩触发器
7. 针对上下文退化进行设计，而不是希望避免它
8. 优先选择高信号的小上下文，而非低信号的大上下文

## 集成

本技能提供了所有其他技能赖以建立的基础上下文。应首先学习本技能，然后再探索：

- `context-degradation` - 理解上下文如何失效
- `context-optimization` - 扩展上下文容量的技术
- `multi-agent-patterns` - 上下文隔离如何启用多智能体系统
- `tool-design` - 工具定义如何与上下文交互

## 参考文献

内部参考：
- [上下文组成部分参考](./references/context-components_zh.md) - 详细的技术参考

本系列中的相关技能：
- `context-degradation` - 理解上下文失效模式
- `context-optimization` - 高效使用上下文的技术

外部资源：
- 关于 Transformer 注意力机制的研究
- 来自领先 AI 实验室的生产工程指南
- 关于上下文窗口管理的框架文档

---

## 技能元数据

**创建日期**: 2025-12-20
**最后更新**: 2025-12-20
**作者**: 上下文工程智能体技能贡献者
**版本**: 1.0.0

