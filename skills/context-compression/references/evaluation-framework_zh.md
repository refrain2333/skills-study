# 上下文压缩评估框架

本文件提供了衡量上下文压缩质量的完整评估框架，包括探针类型、评分标准和 LLM 评委配置。

## 探针类型

### 召回探针 (Recall Probes)

测试从截断的对话历史中保留特定细节的事实保留能力。

**结构：**
```
问题：[询问截断历史中的特定事实]
预期：[应当保留的精确细节]
评分：技术细节的匹配准确度
```

**示例：**
- “启动此调试会话的原始错误消息是什么？”
- “我们决定使用哪个版本的依赖项？”
- “失败的确切命令是什么？”

### 产物探针 (Artifact Probes)

测试文件跟踪和修改感知能力。

**结构：**
```
问题：[询问创建、修改或检查过的文件]
预期：[带有更改说明的完整列表]
评分：文件列表的完整性和更改说明的准确性
```

**示例：**
- “我们修改了哪些文件？描述每个文件的更改。”
- “我们在本次会话中创建了哪些新文件？”
- “我们检查了但未更改哪些配置文件？”

### 连续性探针 (Continuation Probes)

测试在不重新获取上下文的情况下继续工作的能力。

**结构：**
```
问题：[询问后续步骤或当前状态]
预期：[基于会话历史的可操作后续步骤]
评分：无需请求重新读取文件即可继续工作的能力
```

**示例：**
- “我们下一步该做什么？”
- “哪些测试仍然失败，为什么？”
- “我们上一步留下了什么未完成的工作？”

### 决策探针 (Decision Probes)

测试推理链和决策理由的保留情况。

**结构：**
```
问题：[询问为什么做出某个决策]
预期：[导致该决策的推理过程]
评分：决策背景和所考虑替代方案的保留情况
```

**示例：**
- “我们讨论了 Redis 问题的选项。我们决定了什么，为什么？”
- “为什么我们选择连接池而非每个请求建立连接？”
- “对于身份验证修复，我们考虑了哪些替代方案？”

## 评分标准 (Scoring Rubrics)

### 准确性维度 (Accuracy Dimension)

| 准则 | 问题 | 0 分 | 3 分 | 5 分 |
|-----------|----------|---------|---------|---------|
| 事实准确性 (accuracy_factual) | 事实、文件路径和技术细节是否正确？ | 完全错误或凭空捏造 | 基本准确但有细微错误 | 完全准确 |
| 技术准确性 (accuracy_technical) | 代码引用和技术概念是否正确？ | 重大技术错误 | 基本正确但有细微问题 | 技术上非常精确 |

### 上下文感知维度 (Context Awareness Dimension)

| 准则 | 问题 | 0 分 | 3 分 | 5 分 |
|-----------|----------|---------|---------|---------|
| 对话状态 (context_conversation_state) | 响应是否反映了当前的对话状态？ | 对先前的上下文毫无感知 | 有大致感知但存在缺失 | 对对话历史有充分感知 |
| 产物状态 (context_artifact_state) | 响应是否反映了访问过哪些文件/产物？ | 对产物毫无感知 | 部分产物感知 | 完整的产物状态感知 |

### 产物追踪维度 (Artifact Trail Dimension)

| 准则 | 问题 | 0 分 | 3 分 | 5 分 |
|-----------|----------|---------|---------|---------|
| 创建的文件 (artifact_files_created) | 代理是否知道创建了哪些文件？ | 毫无所知 | 知道大部分文件 | 完全掌握 |
| 修改的文件 (artifact_files_modified) | 代理是否知道修改了哪些文件以及更改了什么？ | 毫无所知 | 对大部分修改有良好了解 | 对所有修改有完全掌握 |
| 关键细节 (artifact_key_details) | 代理是否记得函数名、变量名、错误消息？ | 无法召回 | 能召回大部分关键细节 | 完全召回 |

### 完整性维度 (Completeness Dimension)

| 准则 | 问题 | 0 分 | 3 分 | 5 分 |
|-----------|----------|---------|---------|---------|
| 覆盖完整性 (completeness_coverage) | 响应是否回答了问题的各个部分？ | 忽略了大部分内容 | 回答了大部分内容 | 全面回答了所有部分 |
| 深度完整性 (completeness_depth) | 是否提供了足够的细节？ | 肤浅或缺失细节 | 细节充分 | 细节详尽全面 |

### 连续性维度 (Continuity Dimension)

| 准则 | 问题 | 0 分 | 3 分 | 5 分 |
|-----------|----------|---------|---------|---------|
| 工作状态 (continuity_work_state) | 代理是否能在不重新获取先前访问信息的情况下继续？ | 不重新获取所有上下文就无法继续 | 仅需极少量的重新获取即可继续 | 可以无缝继续 |
| 待办状态 (continuity_todo_state) | 代理是否保持对待办任务的感知？ | 丢失了所有 TODO 记录 | 感知良好但有些许缺失 | 完美的任务感知 |
| 推理性 (continuity_reasoning) | 代理是否保留了先前决策背后的理由？ | 对推理过程没有记忆 | 基本记得推理过程 | 出色的理由保留 |

### 指令遵循维度 (Instruction Following Dimension)

| 准则 | 问题 | 0 分 | 3 分 | 5 分 |
|-----------|----------|---------|---------|---------|
| 格式遵循 (instruction_format) | 响应是否遵循了要求的格式？ | 忽略格式 | 基本遵循格式 | 完美遵循格式 |
| 约束遵循 (instruction_constraints) | 响应是否尊重了规定的约束？ | 忽略约束 | 大部分尊重约束 | 完全尊重所有约束 |

## LLM 评委配置

### 系统提示词

```
你是一位评估软件开发对话中 AI 助手响应的专家评估员。

你的任务是根据特定的标准为响应评分。对于每个准则：
1. 仔细阅读准则问题
2. 检查响应中的证据
3. 根据评分指南给出 0-5 分的分数
4. 为你的评分提供简短的理由

请保持客观和一致。重点关注响应中呈现的内容，而非本可以包含的内容。
```

### 评委输入格式

```json
{
  "probe_question": "最初的错误消息是什么？",
  "model_response": "[待评估的响应]",
  "compacted_context": "[提供的压缩上下文]",
  "ground_truth": "[可选：已知的正确答案]",
  "rubric_criteria": ["accuracy_factual", "accuracy_technical", "context_conversation_state"]
}
```

### 评委输出格式

```json
{
  "criterionResults": [
    {
      "criterionId": "accuracy_factual",
      "score": 5,
      "reasoning": "响应正确识别了 401 错误、特定端点和根本原因。"
    }
  ],
  "aggregateScore": 4.8,
  "dimensionScores": {
    "accuracy": 4.9,
    "context_awareness": 4.5,
    "artifact_trail": 3.2,
    "completeness": 5.0,
    "continuity": 4.8,
    "instruction_following": 5.0
  }
}
```

## 基准测试结果参考

不同压缩方法的性能（基于 36,000+ 条消息）：

| 方法 | 总体 | 准确性 | 上下文 | 产物 | 完整性 | 连续性 | 指令 |
|--------|---------|----------|---------|----------|----------|------------|-------------|
| 锚定迭代 | 3.70 | 4.04 | 4.01 | 2.45 | 4.44 | 3.80 | 4.99 |
| 再生摘要 | 3.44 | 3.74 | 3.56 | 2.33 | 4.37 | 3.67 | 4.95 |
| 不透明压缩 | 3.35 | 3.43 | 3.64 | 2.19 | 4.37 | 3.77 | 4.92 |

**主要发现：**

1. **准确性差距**：最佳和最差方法之间相差 0.61 分
2. **上下文感知差距**：相差 0.45 分，锚定迭代方法占优
3. **产物追踪**：普遍较弱 (2.19-2.45)，需要专门处理
4. **完整性和指令遵循**：差异极小

## 统计考量

- 0.26-0.35 分的差异在不同任务类型和会话长度中是一致的
- 该模式在短期和长期会话中均成立
- 该模式在调试、功能实现和代码审查任务中均成立
- 样本量：涵盖数百个压缩点的 36,611 条消息

## 实现说明

### 探针生成

在每个压缩点根据截断的历史记录生成探针：
1. 提取事实陈述用于**召回探针**
2. 提取文件操作用于**产物探针**
3. 提取未完成任务用于**连续性探针**
4. 提取决策点用于**决策探针**

### 评分过程

1. 将探针问题 + 模型响应 + 压缩上下文提供给评委
2. 根据评分标准中的每个准则进行评估
3. 输出包含分数和理由的结构化 JSON
4. 将维度得分计算为加权平均值
5. 将总体得分计算为各维度的非加权平均值

### 盲测 (Blinding)

评委不应知道生成待评估响应的是哪种压缩方法。这可以防止对已知方法的偏见。

