# 工具设计最佳实践

本文档为智能体系统设计工具提供了额外的最佳实践和指南。

## 工具哲学

工具是智能体与世界之间的主要接口。与专为理解底层系统的开发人员设计的传统 API 不同，工具必须为根据描述推断意图并从自然语言请求生成调用的语言模型而设计。这种根本差异要求我们重新思考如何设计和记录工具接口。

目标是创建让智能体无需大量试错即可发现、理解并正确使用的工具。工具定义中的每一个歧义都会成为潜在的故障模式。每一个不清晰的参数名称都会迫使智能体去猜测。每一个缺失的示例都会让智能体在处理边缘情况时失去引导。

## 描述工程原则

### 原则 1：回答基本问题

每个工具描述都应清晰地回答四个问题。**该工具做什么？** 用具体的词汇准确说明工具完成了什么，避免使用“有助于”或“可用于”之类的模糊语言。**何时应该使用？** 提供具体的触发因素和上下文，包括指示工具适用性的直接触发因素和间接信号。**它接受什么输入？** 记录带有类型、约束和默认值的参数，解释每个参数控制什么。**它返回什么？** 描述输出格式和结构，包括成功响应和错误条件的示例。

### 原则 2：使用一致的结构

在代码库的所有工具描述中保持一致的结构。当智能体遇到一个新工具时，它们应该能够根据从其他工具中学到的模式，预测在哪里可以找到特定信息。这减少了认知开销，并防止了由格式不一致引起的错误。

推荐的结构包括：第一句简短描述，包含使用上下文的详细说明，带有清晰类型信息的参数部分，描述输出结构的返回部分，以及列出可能故障模式及恢复指导的错误部分。

### 原则 3：包含具体示例

示例弥合了抽象描述与实际用法之间的鸿沟。包含展示常见参数组合的典型调用示例、边缘情况及其处理方式的示例，以及错误响应和适当恢复操作的示例。

好的示例是具体的而不是通用的。与其说“使用类似 '123' 的 ID”，不如说“使用格式：'CUST-######'（例如 'CUST-000001'）”。与其说“提供日期”，不如说“格式：'YYYY-MM-DD'（例如 '2024-01-15'）”。

## 命名规范

### 参数命名

参数名称应该是自解释的。使用能够清晰指示用途的名称，无需额外解释。倾向于使用完整的单词而不是缩写，除非是广泛理解的缩写（如 "id" 或 "url"）。在不同工具中对相似概念使用一致的命名。

好的参数名称包括 `customer_id`、`search_query`、`output_format`、`max_results` 和 `include_details`。糟糕的参数名称包括 `x`、`val`、`param1` 和 `info`。

### 枚举值

当参数接受枚举值时，在所有工具中使用一致的命名。对于布尔类型的选项，对肯定选项使用前缀模式，如 `include_`（`include_history`, `include_metadata`），对否定选项使用 `exclude_`（`exclude_archived`, `exclude_inactive`）。对于分类值，使用一致的术语，如 `"format": "concise" | "detailed"`，而不是在某些工具中混合使用 `"format": "short" | "long"`，在另一些工具中使用 `"format": "brief" | "complete"`。

## 错误消息设计

### 双重受众

错误消息服务于具有不同需求的两个受众。调试问题的开发人员需要详细的技术信息，包括堆栈跟踪和内部状态。从故障中恢复的智能体需要**可操作的指导**，告诉它们出了什么问题以及如何纠正。

设计错误消息时应将智能体恢复作为首要考虑因素。用清晰的语言说明具体出了什么问题。提供描述智能体接下来应该做什么的解决指导。对于输入错误，包含纠正后的格式。添加有效输入的示例。

### 错误消息结构

```json
{
    "error": {
        "code": "INVALID_CUSTOMER_ID",
        "category": "validation",
        "message": "客户 ID 'CUST-123' 不符合要求的格式",
        "expected_format": {
            "description": "客户 ID 必须为 9 个字符",
            "pattern": "CUST-######",
            "example": "CUST-000001"
        },
        "resolution": "请提供符合 CUST-###### 模式的客户 ID",
        "retryable": true
    }
}
```

### 常见错误模式

验证错误应指定接收到的内容、预期的格式以及如何纠正。频率限制（Rate limit）错误应指定等待时间和重试指导。未找到（Not found）错误应建议替代方法或验证步骤。系统错误应指示重试是否合适并建议替代方案。

## 响应格式优化

### Token 与准确性的权衡

详尽的响应提供了全面的信息，但会消耗大量的上下文 Token。简明的响应最小化了 Token 使用，但可能缺乏必要的细节。最佳方法是提供格式选项，允许智能体根据需求请求适当的详细程度。

### 格式选项模式

```python
def get_customer_response(format: str = "concise"):
    """
    检索客户信息。
    
    参数:
        format: 响应格式 - 'concise' 仅返回关键字段，
                'detailed' 返回完整的客户记录
    """
    if format == "concise":
        return {
            "id": customer.id,
            "name": customer.name,
            "status": customer.status
        }
    else:  # detailed
        return {
            "id": customer.id,
            "name": customer.name,
            "email": customer.email,
            "phone": customer.phone,
            "address": customer.address,
            "status": customer.status,
            "created_at": customer.created_at,
            "history": customer.history,
            "preferences": customer.preferences
        }
```

### 何时使用每种格式

在进行快速验证或简单查找、仅需要确认时，以及在初始检索后的后续工具调用中使用**简明格式**。在根据客户数据做出决策、输出作为其他处理的输入，以及为了正确性必须具备完整上下文时使用**详细格式**。

## 工具集设计

### 管理工具扩散

随着智能体系统的发展，工具集往往会扩散。更多的工具可以实现更多的能力，但也会带来选择挑战。研究表明，工具描述重叠会导致模型混淆。关键见解是：如果人类工程师无法明确说明在特定情况下应该使用哪个工具，那么就不能指望智能体做得更好。

### 合并指南

将代表单个工作流中顺序步骤的工具合并为一个处理整个工作流的工具。例如，与其实现 `list_users`、`list_events` 和 `create_event`，不如实现一个 `schedule_event`，在一次调用中完成查找可用性和调度。

对于行为有根本差异的工具，即使它们共享某些功能，也应保持独立。在不同上下文中使用的工具应保持分离以防止混淆。

即使工具在相似领域运行，也要保持它们之间的清晰边界。应通过仔细设计最小化功能重叠。

### 工具选择指导

在设计工具集时，考虑智能体为了做出正确选择需要哪些信息。如果多种工具都适用于某种情况，请在描述中澄清区别。使用命名空间创建逻辑分组，帮助智能体导航工具空间。

## 测试工具设计

### 评估标准

根据清晰度（Clarity）、完整性（Completeness）、可恢复性（Recoverability）、效率（Efficiency）和一致性（Consistency）标准评估工具设计。清晰度衡量智能体是否能确定何时使用该工具。完整性衡量描述是否包含所有必要信息。可恢复性衡量智能体是否能从错误中恢复。效率衡量工具是否支持适当的响应格式。一致性衡量工具是否遵循命名和模式（Schema）规范。

### 智能体测试模式

通过展示代表性的智能体请求并评估生成的工具调用来测试工具：

1. 准备具有多种智能体请求的测试用例
2. 让智能体为每个请求构思工具调用
3. 根据预期模式评估调用的正确性
4. 识别常见的故障模式
5. 根据发现结果改进工具定义

## 要避免的反模式

### 模糊描述

糟糕：“搜索数据库以获取客户信息。”这留下了太多未回答的问题。什么数据库？有哪些可用信息？查询应该采用什么格式？

良好：“通过 ID 或电子邮件检索客户信息。当用户询问特定客户详情、历史记录或状态时使用。返回包含 id, name, email, account_status 以及可选订单历史记录的客户对象。”

### 晦涩的参数名称

糟糕：名为 `x`、`val` 或 `param1` 的参数会迫使智能体猜测含义。

良好：名为 `customer_id`、`max_results` 或 `include_history` 的参数是自解释的。

### 缺失错误处理

糟糕：因通用错误而失败或没有错误处理的工具。

良好：提供特定错误类型、消息和解决指导的工具。

### 命名不一致

糟糕：在某些工具中使用 `id`，在其他工具中使用 `identifier`，在针对相似概念的某些工具中使用 `customer_id` 而在其他工具中使用 `user_id`。

良好：在所有工具中对相似概念保持一致的命名模式。

## 工具设计自检清单

在部署新工具之前，验证：描述是否清晰说明了工具的作用及何时使用。验证：所有参数是否都有描述性名称和清晰的类型信息。验证：返回值是否记录了结构和示例。验证：错误情况是否涵盖了可操作的消息。验证：工具是否遵循了其他地方使用的命名规范。验证：示例是否展示了常见的使用模式。验证：如果响应大小差异很大，格式选项是否可用。

